---
title: "Диаграммы рантайма"
description: "Справочные диаграммы Mermaid для рантайма Membria CE"
---

> Этот файл содержит справочные диаграммы для рантайма Membria CE.
> Все диаграммы используют Mermaid, поэтому они могут отображаться в пайплайнах GitHub/GitLab и в документации.

---

## 1) Обзор системы

```mermaid
flowchart LR
  U[User] --> UI["Интерфейс клиента\nЧат - Decision Surface - Поиск"]
  UI --> ORCH[Роутер / Оркестратор]

  ORCH --> MEM["Локальные хранилища\nSQLite - DuckDB"]
  ORCH --> GR["Движок GraphRAG\nГраф + Векторы + Ранжирование"]
  ORCH --> SLM[Локальный SLM рантайм]
  ORCH --> DBB["Decision Black Box\nДвижок извлечения"]
  ORCH --> DI["Движок Decision Intelligence\nVoI + POMDP"]

  ORCH -->|Эскалация| GW[Шлюз эскалации]
  GW --> KCG["Глобальный кэш знаний\nДецентрализованный"]
  GW --> COUNCIL["Совет LLM\nМощные модели"]
  COUNCIL --> CUR["Куратор\nВерификация + Слияние + Происхождение"]

  CUR -->|Обратная запись| KCG
  CUR -->|Кэш CAG| MEM
  CUR -->|Обновления онтологии| GR
  CUR -->|Обратная связь DI| DI
  CUR --> SF["SkillForge\nЖизненный цикл LoRA"]
  SF --> SLM
```

---

## 2) Дерево принятия решений о маршрутизации запросов

```mermaid
flowchart TD
  Q[Запрос пользователя] --> M{Режим?}
  M -->|Чат| C1[Пайплайн чата]
  M -->|Decision Surface| D1[Пайплайн DS]
  M -->|Поиск| S1[Пайплайн поиска]

  C1 --> P[Оркестратор строит план]
  S1 --> P
  D1 --> P

  P --> K{Попадание в кэш KCG / локальный?}
  K -->|Да| OUT1[Ответ + цитаты]
  K -->|Нет| L{Локальная SLM уверена?}
  L -->|Да| R1[GraphRAG извлечение + ранжирование]
  R1 --> OUT2[Ответ + цитаты]
  L -->|Нет| E1[Эскалация в Совет]
  E1 --> CUR[Куратор]
  CUR --> OUT3[Ответ + цитаты + обратная запись]
```

---

## 3) Пайплайн индексации (холодный старт)

```mermaid
flowchart LR
  A["Источники (Drive - Email - Slack - Логи)"] --> B["Структурный парсинг (без тяжелых рассуждений)"]
  B --> C["ThoughtUnits (ts, автор, тред, uri, тип)"]
  C --> D[Дешевые эмбеддинги]
  D --> E[Семантическая кластеризация]
  E --> F["Скелет рассуждений (только форма)"]
  F --> G["Консервативные эвристики (флаги дрифта/стабильности)"]
  G --> H[Кандидаты DBB + обновления графа]
  H --> I[DS готов к отрисовке]
```

---

## 4) Жизненный цикл Decision Black Box (DBB)

```mermaid
sequenceDiagram
  participant S as Потоки (Чаты/Инструменты)
  participant P as Парсер (ThoughtUnits)
  participant B as Движок DBB
  participant DI as Движок DI
  participant G as Хранилище GraphRAG
  participant D as Хранилище решений
  participant DS as Decision Surface

  S->>P: Новое сообщение / событие
  P->>B: ThoughtUnit + метаданные
  B->>B: Детектирование кандидатов в решения
  B->>DI: Выброс сигналов (задержка, маркеры)
  DI->>DI: Обновление состояния POMDP
  DI->>DI: Расчет балла VoI
  B->>D: Upsert объекта Решения
  DI->>D: Обновление VoI / Приоритета
  B->>G: Добавление/обновление сущностей/связей
  DS->>D: Запрос решений + статус (приоритет VoI)
  DS->>G: Получение прецедентов + связей
  DS-->>DS: Отрисовка карточек (оповещения POMDP)
```

---

## 5) Эскалация в Совет + цикл кэширования

```mermaid
sequenceDiagram
  participant UI as Интерфейс клиента
  participant OR as Оркестратор
  participant KC as KCG (Кэш)
  participant C as Совет
  participant CU as Куратор
  participant LM as Локальная память
  participant GR as GraphRAG

  UI->>OR: Задать вопрос
  OR->>KC: Поиск в кэше
  alt Попадание в кэш
    KC-->>OR: Верифицированный ответ + цитаты
    OR-->>UI: Ответ
  else Промах кэша
    OR->>C: Эскалация запроса
    C-->>CU: Ответы нескольких моделей
    CU-->>CU: Верификация + слияние + происхождение
    CU->>LM: Сохранение записи CAG
    CU->>GR: Обновление онтологии / связей
    CU->>KC: (Опционально) запись общего артефакта
    OR-->>UI: Ответ с цитатами
  end
```

---

## 6) Цикл Decision Intelligence

```mermaid
flowchart TD
  SIG["Сигналы DBB\nЗадержка - Red-teaming - Логика"] --> POMDP["Трекер POMDP\nМодель убеждений"]
  POMDP -->|Разрыв уверенности| ALERT[Оповещение о скрытом разногласии]
  
  DEC["Объект решения\nСтавки - Неопределенность"] --> VOI["Скоринг VoI\nЦенность информации"]
  VOI -->|Приоритет| RANK[Ранжирование DS]
  
  RANK --> UI[Decision Surface]
  ALERT --> UI
  
  MCTS[Исследователь оптимальных цепочек] -->|Оптимизация| PLAN[Рекомендуемая дорожная карта]
  PLAN --> UI
```
